{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _get from \"@babel/runtime/helpers/esm/get\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport { CompositeLayer, createIterable } from '@deck.gl/core';\nimport MultiIconLayer from './multi-icon-layer/multi-icon-layer';\nimport FontAtlasManager, { DEFAULT_CHAR_SET, DEFAULT_FONT_FAMILY, DEFAULT_FONT_WEIGHT, DEFAULT_FONT_SIZE, DEFAULT_BUFFER, DEFAULT_RADIUS, DEFAULT_CUTOFF } from './font-atlas-manager';\nimport { replaceInRange } from '../utils';\nimport { transformParagraph } from './utils';\nvar DEFAULT_FONT_SETTINGS = {\n  fontSize: DEFAULT_FONT_SIZE,\n  buffer: DEFAULT_BUFFER,\n  sdf: false,\n  radius: DEFAULT_RADIUS,\n  cutoff: DEFAULT_CUTOFF\n};\nvar TEXT_ANCHOR = {\n  start: 1,\n  middle: 0,\n  end: -1\n};\nvar ALIGNMENT_BASELINE = {\n  top: 1,\n  center: 0,\n  bottom: -1\n};\nvar DEFAULT_COLOR = [0, 0, 0, 255];\nvar DEFAULT_LINE_HEIGHT = 1.0;\nvar FONT_SETTINGS_PROPS = ['fontSize', 'buffer', 'sdf', 'radius', 'cutoff'];\nvar defaultProps = {\n  billboard: true,\n  sizeScale: 1,\n  sizeUnits: 'pixels',\n  sizeMinPixels: 0,\n  sizeMaxPixels: Number.MAX_SAFE_INTEGER,\n  characterSet: DEFAULT_CHAR_SET,\n  fontFamily: DEFAULT_FONT_FAMILY,\n  fontWeight: DEFAULT_FONT_WEIGHT,\n  lineHeight: DEFAULT_LINE_HEIGHT,\n  fontSettings: {},\n  getText: {\n    type: 'accessor',\n    value: function value(x) {\n      return x.text;\n    }\n  },\n  getPosition: {\n    type: 'accessor',\n    value: function value(x) {\n      return x.position;\n    }\n  },\n  getColor: {\n    type: 'accessor',\n    value: DEFAULT_COLOR\n  },\n  getSize: {\n    type: 'accessor',\n    value: 32\n  },\n  getAngle: {\n    type: 'accessor',\n    value: 0\n  },\n  getTextAnchor: {\n    type: 'accessor',\n    value: 'middle'\n  },\n  getAlignmentBaseline: {\n    type: 'accessor',\n    value: 'center'\n  },\n  getPixelOffset: {\n    type: 'accessor',\n    value: [0, 0]\n  }\n};\n\nvar TextLayer = function (_CompositeLayer) {\n  _inherits(TextLayer, _CompositeLayer);\n\n  function TextLayer() {\n    _classCallCheck(this, TextLayer);\n\n    return _possibleConstructorReturn(this, _getPrototypeOf(TextLayer).apply(this, arguments));\n  }\n\n  _createClass(TextLayer, [{\n    key: \"initializeState\",\n    value: function initializeState() {\n      this.state = {\n        fontAtlasManager: new FontAtlasManager(this.context.gl)\n      };\n    }\n  }, {\n    key: \"updateState\",\n    value: function updateState(_ref) {\n      var _this = this;\n\n      var props = _ref.props,\n          oldProps = _ref.oldProps,\n          changeFlags = _ref.changeFlags;\n      var fontChanged = this.fontChanged(oldProps, props);\n\n      if (fontChanged) {\n        this.updateFontAtlas({\n          oldProps: oldProps,\n          props: props\n        });\n      }\n\n      var textChanged = changeFlags.dataChanged || fontChanged || props.lineHeight !== oldProps.lineHeight || changeFlags.updateTriggersChanged && (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getText);\n\n      if (textChanged && Array.isArray(changeFlags.dataChanged)) {\n        var data = this.state.data.slice();\n        var dataDiff = changeFlags.dataChanged.map(function (dataRange) {\n          return replaceInRange({\n            data: data,\n            getIndex: function getIndex(p) {\n              return p.__source.index;\n            },\n            dataRange: dataRange,\n            replace: _this.transformStringToLetters(dataRange)\n          });\n        });\n        this.setState({\n          data: data,\n          dataDiff: dataDiff\n        });\n      } else if (textChanged) {\n        this.setState({\n          data: this.transformStringToLetters(),\n          dataDiff: null\n        });\n      }\n    }\n  }, {\n    key: \"finalizeState\",\n    value: function finalizeState() {\n      _get(_getPrototypeOf(TextLayer.prototype), \"finalizeState\", this).call(this);\n\n      this.state.fontAtlasManager.finalize();\n    }\n  }, {\n    key: \"updateFontAtlas\",\n    value: function updateFontAtlas(_ref2) {\n      var oldProps = _ref2.oldProps,\n          props = _ref2.props;\n      var characterSet = props.characterSet,\n          fontSettings = props.fontSettings,\n          fontFamily = props.fontFamily,\n          fontWeight = props.fontWeight;\n      var fontAtlasManager = this.state.fontAtlasManager;\n      fontAtlasManager.setProps(Object.assign({}, DEFAULT_FONT_SETTINGS, fontSettings, {\n        characterSet: characterSet,\n        fontFamily: fontFamily,\n        fontWeight: fontWeight\n      }));\n      var scale = fontAtlasManager.scale,\n          texture = fontAtlasManager.texture,\n          mapping = fontAtlasManager.mapping;\n      this.setState({\n        scale: scale,\n        iconAtlas: texture,\n        iconMapping: mapping\n      });\n      this.setNeedsRedraw(true);\n    }\n  }, {\n    key: \"fontChanged\",\n    value: function fontChanged(oldProps, props) {\n      if (oldProps.fontFamily !== props.fontFamily || oldProps.characterSet !== props.characterSet || oldProps.fontWeight !== props.fontWeight) {\n        return true;\n      }\n\n      if (oldProps.fontSettings === props.fontSettings) {\n        return false;\n      }\n\n      var oldFontSettings = oldProps.fontSettings || {};\n      var fontSettings = props.fontSettings || {};\n      return FONT_SETTINGS_PROPS.some(function (prop) {\n        return oldFontSettings[prop] !== fontSettings[prop];\n      });\n    }\n  }, {\n    key: \"getPickingInfo\",\n    value: function getPickingInfo(_ref3) {\n      var info = _ref3.info;\n      return Object.assign(info, {\n        object: info.index >= 0 ? this.props.data[info.index] : null\n      });\n    }\n  }, {\n    key: \"transformStringToLetters\",\n    value: function transformStringToLetters() {\n      var _this2 = this;\n\n      var dataRange = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var _this$props = this.props,\n          data = _this$props.data,\n          lineHeight = _this$props.lineHeight,\n          getText = _this$props.getText;\n      var iconMapping = this.state.iconMapping;\n      var startRow = dataRange.startRow,\n          endRow = dataRange.endRow;\n\n      var _createIterable = createIterable(data, startRow, endRow),\n          iterable = _createIterable.iterable,\n          objectInfo = _createIterable.objectInfo;\n\n      var transformedData = [];\n      var _iteratorNormalCompletion = true;\n      var _didIteratorError = false;\n      var _iteratorError = undefined;\n\n      try {\n        var _loop = function _loop() {\n          var object = _step.value;\n\n          var transformCharacter = function transformCharacter(transformed) {\n            return _this2.getSubLayerRow(transformed, object, objectInfo.index);\n          };\n\n          objectInfo.index++;\n          var text = getText(object, objectInfo);\n\n          if (text) {\n            transformParagraph(text, lineHeight, iconMapping, transformCharacter, transformedData);\n          }\n        };\n\n        for (var _iterator = iterable[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n          _loop();\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n            _iterator[\"return\"]();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n\n      return transformedData;\n    }\n  }, {\n    key: \"getAnchorXFromTextAnchor\",\n    value: function getAnchorXFromTextAnchor(getTextAnchor) {\n      if (typeof getTextAnchor === 'function') {\n        getTextAnchor = this.getSubLayerAccessor(getTextAnchor);\n        return function (x) {\n          return TEXT_ANCHOR[getTextAnchor(x)] || 0;\n        };\n      }\n\n      return function () {\n        return TEXT_ANCHOR[getTextAnchor] || 0;\n      };\n    }\n  }, {\n    key: \"getAnchorYFromAlignmentBaseline\",\n    value: function getAnchorYFromAlignmentBaseline(getAlignmentBaseline) {\n      if (typeof getAlignmentBaseline === 'function') {\n        getAlignmentBaseline = this.getSubLayerAccessor(getAlignmentBaseline);\n        return function (x) {\n          return TEXT_ANCHOR[getAlignmentBaseline(x)] || 0;\n        };\n      }\n\n      return function () {\n        return ALIGNMENT_BASELINE[getAlignmentBaseline] || 0;\n      };\n    }\n  }, {\n    key: \"renderLayers\",\n    value: function renderLayers() {\n      var _this$state = this.state,\n          data = _this$state.data,\n          dataDiff = _this$state.dataDiff,\n          scale = _this$state.scale,\n          iconAtlas = _this$state.iconAtlas,\n          iconMapping = _this$state.iconMapping;\n      var _this$props2 = this.props,\n          getPosition = _this$props2.getPosition,\n          getColor = _this$props2.getColor,\n          getSize = _this$props2.getSize,\n          getAngle = _this$props2.getAngle,\n          getTextAnchor = _this$props2.getTextAnchor,\n          getAlignmentBaseline = _this$props2.getAlignmentBaseline,\n          getPixelOffset = _this$props2.getPixelOffset,\n          billboard = _this$props2.billboard,\n          sdf = _this$props2.sdf,\n          sizeScale = _this$props2.sizeScale,\n          sizeUnits = _this$props2.sizeUnits,\n          sizeMinPixels = _this$props2.sizeMinPixels,\n          sizeMaxPixels = _this$props2.sizeMaxPixels,\n          transitions = _this$props2.transitions,\n          updateTriggers = _this$props2.updateTriggers;\n      var SubLayerClass = this.getSubLayerClass('characters', MultiIconLayer);\n      return new SubLayerClass({\n        sdf: sdf,\n        iconAtlas: iconAtlas,\n        iconMapping: iconMapping,\n        _dataDiff: dataDiff && function () {\n          return dataDiff;\n        },\n        getPosition: this.getSubLayerAccessor(getPosition),\n        getColor: this.getSubLayerAccessor(getColor),\n        getSize: this.getSubLayerAccessor(getSize),\n        getAngle: this.getSubLayerAccessor(getAngle),\n        getAnchorX: this.getAnchorXFromTextAnchor(getTextAnchor),\n        getAnchorY: this.getAnchorYFromAlignmentBaseline(getAlignmentBaseline),\n        getPixelOffset: this.getSubLayerAccessor(getPixelOffset),\n        getPickingIndex: function getPickingIndex(obj) {\n          return obj.__source.index;\n        },\n        billboard: billboard,\n        sizeScale: sizeScale * scale,\n        sizeUnits: sizeUnits,\n        sizeMinPixels: sizeMinPixels * scale,\n        sizeMaxPixels: sizeMaxPixels * scale,\n        transitions: transitions && {\n          getPosition: transitions.getPosition,\n          getAngle: transitions.getAngle,\n          getColor: transitions.getColor,\n          getSize: transitions.getSize,\n          getPixelOffset: updateTriggers.getPixelOffset\n        }\n      }, this.getSubLayerProps({\n        id: 'characters',\n        updateTriggers: {\n          getPosition: updateTriggers.getPosition,\n          getAngle: updateTriggers.getAngle,\n          getColor: updateTriggers.getColor,\n          getSize: updateTriggers.getSize,\n          getPixelOffset: updateTriggers.getPixelOffset,\n          getAnchorX: updateTriggers.getTextAnchor,\n          getAnchorY: updateTriggers.getAlignmentBaseline\n        }\n      }), {\n        data: data,\n        getIcon: function getIcon(d) {\n          return d.text;\n        },\n        getRowSize: function getRowSize(d) {\n          return d.rowSize;\n        },\n        getOffsets: function getOffsets(d) {\n          return [d.offsetLeft, d.offsetTop];\n        },\n        getParagraphSize: function getParagraphSize(d) {\n          return d.size;\n        }\n      });\n    }\n  }]);\n\n  return TextLayer;\n}(CompositeLayer);\n\nexport { TextLayer as default };\nTextLayer.layerName = 'TextLayer';\nTextLayer.defaultProps = defaultProps;","map":null,"metadata":{},"sourceType":"module"}