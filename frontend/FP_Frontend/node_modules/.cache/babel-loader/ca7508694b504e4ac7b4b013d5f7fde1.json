{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport { isWebGL2, Buffer, TransformFeedback } from '@luma.gl/webgl';\nimport { assert } from '../../utils';\n\nvar BufferTransform = function () {\n  function BufferTransform(gl) {\n    var props = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    _classCallCheck(this, BufferTransform);\n\n    this.gl = gl;\n    this.currentIndex = 0;\n    this.feedbackMap = {};\n    this.varyings = null;\n    this.bindings = [];\n    this.resources = {};\n\n    this._initialize(props);\n\n    Object.seal(this);\n  }\n\n  _createClass(BufferTransform, [{\n    key: \"setupResources\",\n    value: function setupResources(opts) {\n      var _iteratorNormalCompletion = true;\n      var _didIteratorError = false;\n      var _iteratorError = undefined;\n\n      try {\n        for (var _iterator = this.bindings[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n          var binding = _step.value;\n\n          this._setupTransformFeedback(binding, opts);\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n            _iterator[\"return\"]();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n    }\n  }, {\n    key: \"updateModelProps\",\n    value: function updateModelProps() {\n      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var varyings = this.varyings;\n\n      if (varyings.length > 0) {\n        props = Object.assign({}, props, {\n          varyings: varyings\n        });\n      }\n\n      return props;\n    }\n  }, {\n    key: \"getDrawOptions\",\n    value: function getDrawOptions() {\n      var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var binding = this.bindings[this.currentIndex];\n      var sourceBuffers = binding.sourceBuffers,\n          transformFeedback = binding.transformFeedback;\n      var attributes = Object.assign({}, sourceBuffers, opts.attributes);\n      return {\n        attributes: attributes,\n        transformFeedback: transformFeedback\n      };\n    }\n  }, {\n    key: \"swap\",\n    value: function swap() {\n      if (this.feedbackMap) {\n        this.currentIndex = this._getNextIndex();\n        return true;\n      }\n\n      return false;\n    }\n  }, {\n    key: \"update\",\n    value: function update() {\n      var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      this._setupBuffers(opts);\n    }\n  }, {\n    key: \"getBuffer\",\n    value: function getBuffer(varyingName) {\n      var feedbackBuffers = this.bindings[this.currentIndex].feedbackBuffers;\n      var bufferOrParams = varyingName ? feedbackBuffers[varyingName] : null;\n\n      if (!bufferOrParams) {\n        return null;\n      }\n\n      return bufferOrParams instanceof Buffer ? bufferOrParams : bufferOrParams.buffer;\n    }\n  }, {\n    key: \"getData\",\n    value: function getData() {\n      var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n          varyingName = _ref.varyingName;\n\n      var buffer = this.getBuffer(varyingName);\n\n      if (buffer) {\n        return buffer.getData();\n      }\n\n      return null;\n    }\n  }, {\n    key: \"delete\",\n    value: function _delete() {\n      for (var name in this.resources) {\n        this.resources[name][\"delete\"]();\n      }\n    }\n  }, {\n    key: \"_initialize\",\n    value: function _initialize() {\n      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      this._setupBuffers(props);\n\n      this.varyings = props.varyings || Object.keys(this.bindings[this.currentIndex].feedbackBuffers);\n\n      if (this.varyings.length > 0) {\n        assert(isWebGL2(this.gl));\n      }\n    }\n  }, {\n    key: \"_getFeedbackBuffers\",\n    value: function _getFeedbackBuffers(props) {\n      var _props$sourceBuffers = props.sourceBuffers,\n          sourceBuffers = _props$sourceBuffers === void 0 ? {} : _props$sourceBuffers;\n      var feedbackBuffers = {};\n\n      if (this.bindings[this.currentIndex]) {\n        Object.assign(feedbackBuffers, this.bindings[this.currentIndex].feedbackBuffers);\n      }\n\n      if (this.feedbackMap) {\n        for (var sourceName in this.feedbackMap) {\n          var feedbackName = this.feedbackMap[sourceName];\n\n          if (sourceName in sourceBuffers) {\n            feedbackBuffers[feedbackName] = sourceName;\n          }\n        }\n      }\n\n      Object.assign(feedbackBuffers, props.feedbackBuffers);\n\n      for (var bufferName in feedbackBuffers) {\n        var bufferOrRef = feedbackBuffers[bufferName];\n\n        if (typeof bufferOrRef === 'string') {\n          var sourceBuffer = sourceBuffers[bufferOrRef];\n          var byteLength = sourceBuffer.byteLength,\n              usage = sourceBuffer.usage,\n              accessor = sourceBuffer.accessor;\n          feedbackBuffers[bufferName] = this._createNewBuffer(bufferName, {\n            byteLength: byteLength,\n            usage: usage,\n            accessor: accessor\n          });\n        }\n      }\n\n      return feedbackBuffers;\n    }\n  }, {\n    key: \"_setupBuffers\",\n    value: function _setupBuffers() {\n      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var _props$sourceBuffers2 = props.sourceBuffers,\n          sourceBuffers = _props$sourceBuffers2 === void 0 ? null : _props$sourceBuffers2;\n      Object.assign(this.feedbackMap, props.feedbackMap);\n\n      var feedbackBuffers = this._getFeedbackBuffers(props);\n\n      this._updateBindings({\n        sourceBuffers: sourceBuffers,\n        feedbackBuffers: feedbackBuffers\n      });\n    }\n  }, {\n    key: \"_setupTransformFeedback\",\n    value: function _setupTransformFeedback(binding, _ref2) {\n      var model = _ref2.model;\n      var program = model.program;\n      binding.transformFeedback = new TransformFeedback(this.gl, {\n        program: program,\n        buffers: binding.feedbackBuffers\n      });\n    }\n  }, {\n    key: \"_updateBindings\",\n    value: function _updateBindings(opts) {\n      this.bindings[this.currentIndex] = this._updateBinding(this.bindings[this.currentIndex], opts);\n\n      if (this.feedbackMap) {\n        var _this$_swapBuffers = this._swapBuffers(this.bindings[this.currentIndex]),\n            sourceBuffers = _this$_swapBuffers.sourceBuffers,\n            feedbackBuffers = _this$_swapBuffers.feedbackBuffers;\n\n        var nextIndex = this._getNextIndex();\n\n        this.bindings[nextIndex] = this._updateBinding(this.bindings[nextIndex], {\n          sourceBuffers: sourceBuffers,\n          feedbackBuffers: feedbackBuffers\n        });\n      }\n    }\n  }, {\n    key: \"_updateBinding\",\n    value: function _updateBinding(binding, opts) {\n      if (!binding) {\n        return {\n          sourceBuffers: Object.assign({}, opts.sourceBuffers),\n          feedbackBuffers: Object.assign({}, opts.feedbackBuffers)\n        };\n      }\n\n      Object.assign(binding.sourceBuffers, opts.sourceBuffers);\n      Object.assign(binding.feedbackBuffers, opts.feedbackBuffers);\n\n      if (binding.transformFeedback) {\n        binding.transformFeedback.setBuffers(binding.feedbackBuffers);\n      }\n\n      return binding;\n    }\n  }, {\n    key: \"_swapBuffers\",\n    value: function _swapBuffers(opts) {\n      if (!this.feedbackMap) {\n        return null;\n      }\n\n      var sourceBuffers = Object.assign({}, opts.sourceBuffers);\n      var feedbackBuffers = Object.assign({}, opts.feedbackBuffers);\n\n      for (var srcName in this.feedbackMap) {\n        var dstName = this.feedbackMap[srcName];\n        sourceBuffers[srcName] = opts.feedbackBuffers[dstName];\n        feedbackBuffers[dstName] = opts.sourceBuffers[srcName];\n        assert(feedbackBuffers[dstName] instanceof Buffer);\n      }\n\n      return {\n        sourceBuffers: sourceBuffers,\n        feedbackBuffers: feedbackBuffers\n      };\n    }\n  }, {\n    key: \"_createNewBuffer\",\n    value: function _createNewBuffer(name, opts) {\n      var buffer = new Buffer(this.gl, opts);\n\n      if (this.resources[name]) {\n        this.resources[name][\"delete\"]();\n      }\n\n      this.resources[name] = buffer;\n      return buffer;\n    }\n  }, {\n    key: \"_getNextIndex\",\n    value: function _getNextIndex() {\n      return (this.currentIndex + 1) % 2;\n    }\n  }]);\n\n  return BufferTransform;\n}();\n\nexport { BufferTransform as default };","map":null,"metadata":{},"sourceType":"module"}